# AGENTS.md — Working Instructions for AI Coding Agents

This document tells AI assistants how to operate inside the **Forestlands Backend** repository.

## Mission

Implement and evolve the **Forestlands** backend according to the functional spec while keeping the codebase simple, testable, and aligned with the MVP roadmap.

**Primary sources of truth (read first):**
- `/docs/functional-spec.md` — user-facing requirements (MVP vs post-MVP).
- `/docs/agents-context.md` — condensed, always-current summary for agents (entities, rules).
- `/README.md` — setup and dev conventions.

> If these documents disagree, prefer `/docs/functional-spec.md`. Propose a fix via PR that updates both files consistently.

---

## Architectural Principles

- **Monolith** (Spring Boot 3, Java 21).
- **MySQL 8** with **Hibernate/JPA** for persistence.
- **Flyway** migrations (append-only). No destructive changes without explicit human approval.
- **REST + JWT** auth. Access tokens (≈15 min), refresh (≈30 days), issuer `forestlands`.
- **Deterministic behavior** and **observability** (logs and audit tables).

---

## Domain (MVP)

Implement entities and services for:

- **User**: email, password hash, createdAt; password reset flow.
- **FocusSession**: `uuid`, `userId`, `speciesId`, start/end timestamps (client+server), `state` (`SUCCESS`/`INTERRUPTED`), duration, drift metrics, optional tag.
    - Valid if duration ≥ `app.session.minMinutes` and ≤ `app.session.maxMinutes`.
    - Client/server drift allowed ± `app.session.maxDriftMinutes`.
    - Overlaps allowed; log but do not block.
- **Species**: catalog entries, flags for default/unlockable, pricing (`coins`/`crystals`), premium flag, active flag.
- **Unlock/Entitlement**: permanent per-user species unlock.
- **Wallet**: per-user balances (`coins`, `crystals`) with **WalletTransaction** audit for every delta.
- **InventoryTree**: instance produced by a successful session; links to `speciesId` and `sessionUuid`; immutable once placed.
- **Map**: per-user 10×10 grid with **MapCell** rows; one tree per cell; placement creates a record and marks the cell occupied. Initial maps generated from templates (seeded data).

> See `/docs/functional-spec.md` for wording details; do not invent new game mechanics unless asked. Add fields that make forward-compatibility easy (e.g., `isActive`, `ruleJson`) but keep unused features off by default.

---

## Coding Conventions

- **Package root**: `io.forestlands.backend`.
- **Spring configuration**: Java config, no field injection; prefer constructor injection.
- **Controllers**: annotated with `@RestController`, return DTOs (no JPA entities).
- **DTO mapping**: write simple mappers.
- **Validation**: Bean Validation (`jakarta.validation`) on request DTOs; fail fast with meaningful messages.
- **Transactions**: service layer boundaries; never in controllers.
- **Errors**: centralized `@ControllerAdvice`; payload: `{ timestamp, path, code, message, details? }`.
- **Security**: Spring Security with JWT filter; BCrypt password encoder.
- **Testing**: JUnit 5; Repository tests with Testcontainers (MySQL); Service tests use mocks; Controller tests with `@WebMvcTest`.

---

## Migrations & Seed

- Create migrations under `src/main/resources/db/migration/` as `V###__description.sql`.
- Seed initial **species** and **map templates** via migrations.
- Never edit old migration files. Add a new version.

---

## Logging & Audit

- Business events at INFO only if they’re important (e.g., session finished, wallet delta).
- Use a **WalletTransaction** table to record every coins/crystals change.
- Record anomalies (e.g., drift > allowed, negative durations) in an **AnomalyLog** table.

---

## What You May Implement Autonomously

- JPA entities + repositories per the domain above.
- Services with transactional boundaries.
- Controllers for MVP endpoints (auth, sessions, species, wallet, inventory, map).
- DTOs, mappers, validation annotations.
- Flyway migrations and seed data for species/map templates.
- Tests (unit + slice + Testcontainers).
- Documentation updates in `/README.md`, `/docs/functional-spec.md`, `/agents/context.md`.

> Before introducing a new dependency, prefer standard Spring Boot starters. If a new dependency is essential, justify it in the PR description.

---

## Non-Goals (Do Not Do Without Human Approval)

- Payment integrations (StoreKit/Stripe) — post-MVP.
- Social features (view other maps).
- Enforced focus mechanics (site blocker, iOS app switch kill).
- Deleting production data (other than soft deletes or documented manual ops).
- Changing public API shapes already used by clients without a migration note.

---

## Branching & Commits

- Branches: `feature/<short-name>`, `fix/<short-name>`, `chore/<short-name>`.
- Commits: conventional style:
    - `feat: add inventory tree placement service`
    - `fix: prevent negative wallet deltas`
    - `chore: add V3__seed_species.sql`

Open a PR with:
1. Summary of changes
2. Any new config/env keys
3. Migration numbers added
4. Screenshots of Swagger / sample curl if relevant

---

## Example Tasks You Can Execute

- “Implement `FocusSession` entity/repo/service with sanity checks using config values.”
- “Add `WalletTransaction` audit; award `coins = minutes` on SUCCESS.”
- “Seed 3 default and 3 unlockable species in `V2__seed_species.sql`.”
- “Create map template seeding (`V3__seed_map_templates.sql`) and per-user map generation on signup.”
- “Add idempotency support to session start/finish.”
- “Expose `/reports/tags` (basic group-by) — if asked.”

---

## Tooling Notes

- Assume **Maven** build (`mvn verify`, `mvn spring-boot:run`).
- Use **Testcontainers** for integration tests when DB is needed.
- Prefer Java time (`Instant`, `Duration`) and UTC everywhere.

---

## Security & Secrets

- No secrets in the repo. Use env or `application-local.yml` (gitignored).
- JWT secret must be provided for any non-test profile.
- Never log tokens, passwords, or PII.

---

## When In Doubt

- Re-read `/docs/functional-spec.md`.
- Prefer the simplest implementation that satisfies MVP.
- Add TODOs with a clear follow-up note and reference to the spec section.
- Propose small PRs; avoid “big bang” changes.